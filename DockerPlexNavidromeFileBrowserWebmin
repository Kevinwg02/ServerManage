#!/bin/bash

set -e

echo "üì¶ Mise √† jour du syst√®me..."
sudo apt update && sudo apt upgrade -y

echo "üê≥ Installation de Docker (si pas d√©j√† fait)..."
if ! command -v docker &> /dev/null; then
    sudo apt install -y apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io
    sudo usermod -aG docker $USER
else
    echo "‚úÖ Docker est d√©j√† install√©"
fi

echo "üìÅ Cr√©ation des dossiers..."
mkdir -p /home/admink/plex/config
mkdir -p /hdd/Films /hdd/Series /hdd/Musique
mkdir -p /opt/navidrome/data

echo "üöÄ D√©ploiement de Plex (Docker)..."
docker run -d \
  --name=plex \
  -e PUID=1000 \
  -e PGID=1000 \
  -e VERSION=docker \
  -e ADVERTISE_IP=http://192.168.1.250:32400/ \
  -e PLEX_CLAIM="claim-35434354" \
  -v /home/admink/plex/config:/config \
  -v /hdd/Films:/data/films \
  -v /hdd/Series:/data/series \
  -p 32400:32400 \
  --network=host \
  --restart unless-stopped \
  linuxserver/plex

echo "üé∂ D√©ploiement de Navidrome (Docker)..."
docker run -d \
  --name navidrome \
  --restart=unless-stopped \
  --user $(id -u):$(id -g) \
  -v /hdd/Musique:/music \
  -v /opt/navidrome/data:/data \
  -p 4533:4533 \
  -e ND_LOGLEVEL=info \
  -e ND_MUSICFOLDER=/music \
  deluan/navidrome:latest

echo "üß≠ Installation de Portainer (Docker)..."
docker volume create portainer_data
docker run -d \
  -p 9000:9000 -p 9443:9443 \
  --name=portainer \
  --restart=unless-stopped \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v portainer_data:/data \
  portainer/portainer-ce:latest

echo "üìÇ Installation de Filebrowser (natif)..."
sudo curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash
sudo mkdir -p /etc/filebrowser
sudo filebrowser -d /etc/filebrowser/filebrowser.db config init
sudo filebrowser config set --port 8080 --root / --noauth=false
sudo filebrowser users add admin admin --perm.admin

# Cr√©ation d‚Äôun service systemd
sudo tee /etc/systemd/system/filebrowser.service > /dev/null <<EOL
[Unit]
Description=Filebrowser
After=network.target

[Service]
ExecStart=/usr/local/bin/filebrowser -d /etc/filebrowser/filebrowser.db
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOL

sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable filebrowser
sudo systemctl start filebrowser

echo "üîß Installation de Webmin..."
wget -q http://www.webmin.com/jcameron-key.asc -O- | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/webmin.gpg
sudo sh -c 'echo "deb https://download.webmin.com/download/repository sarge contrib" > /etc/apt/sources.list.d/webmin.list'
sudo apt update
sudo apt install -y webmin

echo "‚úÖ Tout est install√© !
- Plex : http://192.168.1.250:32400
- Navidrome : http://192.168.1.250:4533
- Portainer : http://192.168.1.250:9000
- Filebrowser : http://192.168.1.250:8080 (login: admin / mdp: admin)
- Webmin : https://192.168.1.250:10000
‚ö†Ô∏è Pense √† red√©marrer ou te d√©connecter pour que Docker soit pleinement utilisable par ton user."
